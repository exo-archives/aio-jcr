<project>
  <parent>
    <groupId>org.exoplatform.jcr</groupId>
    <artifactId>config</artifactId>
    <version>1.6</version>
  </parent>

  <modelVersion>4.0.0</modelVersion>
  <artifactId>exo.product.jcr</artifactId>
  <packaging>exo-product</packaging>
  <version>${org.exoplatform.jcr.version}</version>
  <name>eXo JCR Product</name>
  <url>http://www.exoplatform.org</url>
  <description>eXo JCR Product</description>

  <dependencies>

    <dependency>
      <groupId>org.exoplatform.jcr</groupId>
      <artifactId>exo.jcr.applications.fckeditor</artifactId>
      <version>${org.exoplatform.jcr.version}</version>
      <type>war</type>
      <scope>runtime</scope>
    </dependency>

    <dependency>
      <groupId>org.exoplatform.jcr</groupId>
      <artifactId>exo.jcr.applications.browser</artifactId>
      <version>${org.exoplatform.jcr.version}</version>
      <type>war</type>
      <scope>runtime</scope>
    </dependency>

    <dependency>
      <groupId>org.exoplatform.jcr</groupId>
      <artifactId>exo.jcr.applications.webdav</artifactId>
      <version>${org.exoplatform.jcr.version}</version>
      <type>war</type>
      <scope>runtime</scope>
    </dependency>

    <dependency>
      <groupId>org.exoplatform.jcr</groupId>
      <artifactId>exo.jcr.component.ext</artifactId>
      <version>${org.exoplatform.jcr.version}</version>
      <scope>compile</scope>
    </dependency>

  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-exo-plugin</artifactId>
        <extensions>true</extensions>
        <configuration>

      <!-- Application servers configuration -->
          <deployConfigurations>
            <DeployConfiguration>
              <serverType>tomcat-server</serverType>
              <serverPatchs>
                <serverPatch>product-patches/as/tomcat5</serverPatch>
              </serverPatchs>
              <serverConfig>product-patches/as/tomcat5</serverConfig>
              <deployServerDir>${exo.directory.working}/exo-tomcat</deployServerDir>
              <deployLibDir>${exo.directory.working}/exo-tomcat/common/lib</deployLibDir>
              <deployWebappDir>${exo.directory.working}/exo-tomcat/webapps</deployWebappDir>
              <cleanServerDir>${exo.directory.dependencies}/${exo.server.tomcat}</cleanServerDir>
              <useCleanServer>${clean}</useCleanServer>
              <defaultPortalDir>${exo.directory.working}/exo-tomcat/webapps/portal</defaultPortalDir>
              <ignoredFiles>${exo.ignore.files}</ignoredFiles>
              <deployDependencyScope>${scope}</deployDependencyScope>
              <excludeProjects>${exo.exclude.projects}, commons-collections</excludeProjects>
              <scripts>
                <script>org.exoplatform.maven.plugin.exo.Command$NewServer.class</script>
                <script>org.exoplatform.maven.plugin.exo.Command$PatchServerConfig.class</script>
                <script>org.exoplatform.maven.plugin.exo.Command$DeployProject.class</script>
                <script>org.exoplatform.maven.plugin.exo.Command$CreatePortalXml.class</script>
              </scripts>
            </DeployConfiguration>
            <DeployConfiguration>
              <serverType>jboss-server</serverType>
              <serverConfig>product-patches/as/jboss</serverConfig>
              <deployServerDir>${exo.directory.working}/exo-jboss</deployServerDir>
              <deployLibDir>${exo.directory.working}/exo-jboss/server/default/deploy/exoplatform.sar</deployLibDir>
              <deployWebappDir>${exo.directory.working}/exo-jboss/server/default/deploy/exoplatform.sar</deployWebappDir>
              <cleanServerDir>${exo.directory.dependencies}/${exo.server.jboss}</cleanServerDir>
              <deployDependencyScope>${scope}</deployDependencyScope>
              <useCleanServer>${clean}</useCleanServer>
              <ignoredFiles>${exo.ignore.files}</ignoredFiles>
              <excludeProjects>${exo.exclude.projects}</excludeProjects>
              <scripts>
                <script>org.exoplatform.maven.plugin.exo.Command$NewServer.class</script>
                <script>org.exoplatform.maven.plugin.exo.Command$PatchConfigJboss.class</script>
                <script>org.exoplatform.maven.plugin.exo.Command$DeployProject.class</script>
                <script>org.exoplatform.maven.plugin.exo.Command$CreateManifest.class</script>
                <script>org.exoplatform.maven.plugin.exo.Command$CreateEarApplicationXml.class</script>
              </scripts>
            </DeployConfiguration>
            <DeployConfiguration>
              <serverType>jonas-server</serverType>
              <serverPatchs>
                <serverPatch>product-patches/as/jonas</serverPatch>
              </serverPatchs>
              <serverConfig>product-patches/as/jonas</serverConfig>
              <deployServerDir>${exo.directory.working}/exo-jonas</deployServerDir>
              <deployLibDir>${exo.directory.working}/exo-jonas/lib/apps</deployLibDir>
              <deployWebappDir>${exo.directory.working}/exo-jonas/apps/autoload/exoplatform.ear</deployWebappDir>
              <deployEjbDir>${exo.directory.working}/exo-jonas/apps/autoload/exoplatform.ear</deployEjbDir>
              <deployRarDir>${exo.directory.working}/exo-jonas/apps/autoload/exoplatform.ear</deployRarDir>
              <cleanServerDir>${exo.directory.dependencies}/${exo.server.jonas}</cleanServerDir>
              <deployDependencyScope>${scope}</deployDependencyScope>
              <useCleanServer>${clean}</useCleanServer>
              <ignoredFiles>${exo.ignore.files}</ignoredFiles>
              <excludeProjects>${exo.exclude.projects}</excludeProjects>
              <scripts>
                <script>org.exoplatform.maven.plugin.exo.Command$NewServer.class</script>
                <script>org.exoplatform.maven.plugin.exo.Command$PatchServerConfig.class</script>
                <script>org.exoplatform.maven.plugin.exo.Command$DeployProject.class</script>
                <script>org.exoplatform.maven.plugin.exo.Command$CreateManifest.class</script>
                <script>org.exoplatform.maven.plugin.exo.Command$CreateEarApplicationXml.class</script>
                <script>
                  def DeployServerDir = deployConfig.getDeployServerDir();
                  if (System.getProperty("os.name").toLowerCase().startsWith("win")) {
                    def process = DeployServerDir + "\\bin\\nt\\post-patch.bat";
                  }
                  else {
                    def process = DeployServerDir + "/bin/unix/post-patch.sh";
                    try {
                      ("chmod +x " + process).execute().in.eachLine { println it };
                    } catch(Exception e) {
                      System.err.println("[ERROR] " + e.toString());
                    }
                  }
                  try {
                    print "\n[PATCH] Moving appropriate files to complete deployment\n";
                    process.execute().in.eachLine { println it };
                  } catch(Exception e) {
                    System.err.println("[ERROR] " + e.toString());
                  }
                </script>
              </scripts>
            </DeployConfiguration>
          </deployConfigurations>
        </configuration>
      </plugin>

    </plugins>
  </build>
</project>
