Index: component/core/src/main/java/org/exoplatform/services/jcr/impl/xml/importing/BaseXmlImporter.java
===================================================================
--- component/core/src/main/java/org/exoplatform/services/jcr/impl/xml/importing/BaseXmlImporter.java	(revision 63937)
+++ component/core/src/main/java/org/exoplatform/services/jcr/impl/xml/importing/BaseXmlImporter.java	(working copy)
@@ -16,29 +16,7 @@
  */
 package org.exoplatform.services.jcr.impl.xml.importing;
 
-import java.io.IOException;
-import java.util.ArrayList;
-import java.util.Collections;
-import java.util.Comparator;
-import java.util.List;
-import java.util.Map;
-import java.util.Stack;
-import java.util.StringTokenizer;
-
-import javax.jcr.ImportUUIDBehavior;
-import javax.jcr.ItemExistsException;
-import javax.jcr.ItemNotFoundException;
-import javax.jcr.NamespaceException;
-import javax.jcr.NamespaceRegistry;
-import javax.jcr.PathNotFoundException;
-import javax.jcr.RepositoryException;
-import javax.jcr.nodetype.ConstraintViolationException;
-import javax.jcr.nodetype.NoSuchNodeTypeException;
-import javax.jcr.nodetype.NodeDefinition;
-import javax.jcr.version.VersionException;
-
 import org.apache.commons.logging.Log;
-
 import org.exoplatform.services.jcr.access.AccessControlEntry;
 import org.exoplatform.services.jcr.access.AccessControlList;
 import org.exoplatform.services.jcr.access.AccessManager;
@@ -72,6 +50,27 @@
 import org.exoplatform.services.log.ExoLogger;
 import org.exoplatform.services.security.ConversationState;
 
+import java.io.IOException;
+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.Comparator;
+import java.util.List;
+import java.util.Map;
+import java.util.Stack;
+import java.util.StringTokenizer;
+
+import javax.jcr.ImportUUIDBehavior;
+import javax.jcr.ItemExistsException;
+import javax.jcr.ItemNotFoundException;
+import javax.jcr.NamespaceException;
+import javax.jcr.NamespaceRegistry;
+import javax.jcr.PathNotFoundException;
+import javax.jcr.RepositoryException;
+import javax.jcr.nodetype.ConstraintViolationException;
+import javax.jcr.nodetype.NoSuchNodeTypeException;
+import javax.jcr.nodetype.NodeDefinition;
+import javax.jcr.version.VersionException;
+
 /**
  * Created by The eXo Platform SAS.
  * 
@@ -79,7 +78,7 @@
  * @version $Id$
  */
 public abstract class BaseXmlImporter implements ContentImporter {
-   
+
   private static final String         SESSION_ID = "00base0xml0importer0session0id00";
 
   protected final AccessManager       accessManager;
@@ -113,7 +112,7 @@
 
   protected final ValueFactoryImpl    valueFactory;
 
-  private final Log                   log = ExoLogger.getLogger("jcr.ImporterBase");
+  private final Log                   log        = ExoLogger.getLogger("jcr.ImporterBase");
 
   public BaseXmlImporter(NodeData parent,
                          QPath ancestorToSave,
@@ -402,7 +401,8 @@
   }
 
   /**
-   * Check if parentNodeType and parentMixinNames allowed nodeTypeName as nodetype of subnode.
+   * Check if parentNodeType and parentMixinNames allowed nodeTypeName as
+   * nodetype of subnode.
    * 
    * @param parentNodeType
    * @param parentMixinNames
@@ -496,13 +496,11 @@
     // update parentIdentifer
     for (ItemState state : changesLog.getAllStates()) {
       ItemData data = state.getData();
-      if (data.getParentIdentifier().equals(oldIdentifer)) {
+      if (data.getParentIdentifier() != null && data.getParentIdentifier().equals(oldIdentifer)) {
         ((ImportItemData) data).setParentIdentifer(identifier);
         if (reloadSNS)
           ((ImportItemData) data).setQPath(QPath.makeChildPath(newPath, data.getQPath().getName()));
-
       }
-
     }
 
     currentNodeInfo.setIdentifier(identifier);
@@ -521,9 +519,9 @@
         acl = new AccessControlList(owner, readACLPermisions(exoPermissions));
       } else if (parentACL != null) {
         // use permissions from existed parent
-        acl = new AccessControlList(owner, parentACL.hasPermissions()
-            ? parentACL.getPermissionEntries()
-            : null);
+        acl = new AccessControlList(owner,
+                                    parentACL.hasPermissions() ? parentACL.getPermissionEntries()
+                                                              : null);
       } else {
         // have to search nearest ancestor permissions in ACL manager
         // acl = new AccessControlList(owner,
@@ -547,9 +545,9 @@
     } else {
       if (parentACL != null)
         // construct ACL from existed parent ACL
-        acl = new AccessControlList(parentACL.getOwner(), parentACL.hasPermissions()
-            ? parentACL.getPermissionEntries()
-            : null);
+        acl = new AccessControlList(parentACL.getOwner(),
+                                    parentACL.hasPermissions() ? parentACL.getPermissionEntries()
+                                                              : null);
       else
         // have to search nearest ancestor owner and permissions in ACL manager
         // acl = traverseACL(cpid);
@@ -559,13 +557,13 @@
   }
 
   /**
-   * Return permission values or throw an exception. We assume the node is mix:privilegeable.
+   * Return permission values or throw an exception. We assume the node is
+   * mix:privilegeable.
    * 
-   * @param cid
-   *          Node id
+   * @param cid Node id
    * @return list of ACL entries
-   * @throws IllegalACLException
-   *           if property exo:permissions is not found for node
+   * @throws IllegalACLException if property exo:permissions is not found for
+   *           node
    */
   protected List<AccessControlEntry> readACLPermisions(List<String> exoPermissions) {
     List<AccessControlEntry> naPermissions = new ArrayList<AccessControlEntry>();
@@ -580,13 +578,15 @@
   }
 
   /**
-   * Check if item with uuid=identifier exists. If no item exist return same identifier. If same
-   * uuid item exist and depend on uuidBehavior do:
+   * Check if item with uuid=identifier exists. If no item exist return same
+   * identifier. If same uuid item exist and depend on uuidBehavior do:
    * <ol>
-   * <li>IMPORT_UUID_CREATE_NEW - return null. Caller will create new identifier.</li>
-   * <li>IMPORT_UUID_COLLISION_REMOVE_EXISTING - Remove same uuid item and his subtree. Also if item
-   * MIX_VERSIONABLE, remove version history</li>
-   * <li>IMPORT_UUID_COLLISION_REPLACE_EXISTING - Remove same uuid item and his subtree.</li>
+   * <li>IMPORT_UUID_CREATE_NEW - return null. Caller will create new
+   * identifier.</li>
+   * <li>IMPORT_UUID_COLLISION_REMOVE_EXISTING - Remove same uuid item and his
+   * subtree. Also if item MIX_VERSIONABLE, remove version history</li>
+   * <li>IMPORT_UUID_COLLISION_REPLACE_EXISTING - Remove same uuid item and his
+   * subtree.</li>
    * <li>IMPORT_UUID_COLLISION_THROW - throw new ItemExistsException</li>
    * </ol>
    * 
@@ -647,14 +647,10 @@
   /**
    * Return list of changes for item.
    * 
-   * @param parentData
-   *          - parent item
-   * @param name
-   *          - item name
-   * @param state
-   *          - state
-   * @param skipIdentifier
-   *          - skipped identifier.
+   * @param parentData - parent item
+   * @param name - item name
+   * @param state - state
+   * @param skipIdentifier - skipped identifier.
    * @return
    */
   private List<ItemState> getItemStatesList(NodeData parentData,
@@ -695,10 +691,8 @@
   /**
    * Check if item <b>parent</b> is parent item of item <b>data</b>.
    * 
-   * @param data
-   *          - Possible child ItemData.
-   * @param parent
-   *          - Possible parent ItemData.
+   * @param data - Possible child ItemData.
+   * @param parent - Possible parent ItemData.
    * @return True if parent of both ItemData the same.
    */
   private boolean isParent(ItemData data, ItemData parent) {
@@ -762,8 +756,7 @@
   /**
    * Remove version history of versionable node.
    * 
-   * @param mixVersionableNode
-   *          - node
+   * @param mixVersionableNode - node
    * @throws RepositoryException
    * @throws ConstraintViolationException
    * @throws VersionException
@@ -797,7 +790,8 @@
   }
 
   /**
-   * Class helps sort ItemStates list. After sorting the delete states has to be on top of the list
+   * Class helps sort ItemStates list. After sorting the delete states has to be
+   * on top of the list
    */
   private class PathSorter implements Comparator<ItemState> {
     /*
Index: component/core/src/test/java/org/exoplatform/services/jcr/api/importing/TestImportReferenceable.java
===================================================================
--- component/core/src/test/java/org/exoplatform/services/jcr/api/importing/TestImportReferenceable.java	(revision 0)
+++ component/core/src/test/java/org/exoplatform/services/jcr/api/importing/TestImportReferenceable.java	(revision 0)
@@ -0,0 +1,136 @@
+/*
+ * Copyright (C) 2003-2010 eXo Platform SAS.
+ *
+ * This program is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Affero General Public License
+ * as published by the Free Software Foundation; either version 3
+ * of the License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU General Public License for more details.
+ *
+ * You should have received a copy of the GNU General Public License
+ * along with this program; if not, see<http://www.gnu.org/licenses/>.
+ */
+package org.exoplatform.services.jcr.api.importing;
+
+import org.exoplatform.services.jcr.datamodel.NodeData;
+import org.exoplatform.services.jcr.impl.core.NodeImpl;
+import org.exoplatform.services.jcr.impl.core.SessionImpl;
+import org.exoplatform.services.jcr.impl.core.nodetype.NodeTypeManagerImpl;
+import org.exoplatform.services.jcr.impl.dataflow.session.TransactionableDataManager;
+import org.exoplatform.services.jcr.impl.xml.ExportImportFactory;
+import org.exoplatform.services.jcr.impl.xml.importing.ContentImporter;
+import org.exoplatform.services.jcr.impl.xml.importing.StreamImporter;
+
+import java.io.File;
+import java.io.FileInputStream;
+import java.io.FileOutputStream;
+import java.util.HashMap;
+import java.util.Map;
+
+import javax.jcr.ImportUUIDBehavior;
+import javax.jcr.Node;
+import javax.jcr.NodeIterator;
+import javax.jcr.Session;
+
+/**
+ * Created by The eXo Platform SAS Author : eXoPlatform exo@exoplatform.com
+ * 13.12.2010
+ */
+public class TestImportReferenceable extends AbstractCollisionTest {
+
+  public void tearDown() throws Exception {
+
+    // cleanup ws1
+    Session sysSession = repository.getSystemSession("ws1");
+    NodeIterator nit = sysSession.getRootNode().getNodes();
+    while (nit.hasNext()) {
+      nit.nextNode().remove();
+      sysSession.save();
+    }
+    // cleanup ws2
+    sysSession = repository.getSystemSession("ws2");
+    nit = sysSession.getRootNode().getNodes();
+    while (nit.hasNext()) {
+      nit.nextNode().remove();
+      sysSession.save();
+    }
+    super.tearDown();
+  }
+
+  /**
+   * Usecase: put a referenceable node into workspace export full workspace
+   * content import this data into another workspace There must not be
+   * NullPointerException.
+   * 
+   * @throws Exception
+   */
+  public void testJCR1479ExportImportWorkspaceWithReference() throws Exception {
+    // cleanup ws1 content
+    Session sysSession = repository.getSystemSession("ws1");
+    NodeIterator nit = sysSession.getRootNode().getNodes();
+    while (nit.hasNext()) {
+      nit.nextNode().remove();
+      sysSession.save();
+    }
+
+    File tempFile = File.createTempFile("testJCR1479", "suf");
+    FileOutputStream fout = null;
+    FileInputStream fin = null;
+    // take a ws1 session
+    SessionImpl sessWS1 = (SessionImpl) repository.login(credentials, "ws1");
+    try {
+
+      // make mix:referenceable node
+      Node n = sessWS1.getRootNode().addNode("testRefNode");
+      n.addMixin("mix:referenceable");
+      sessWS1.save();
+
+      fout = new FileOutputStream(tempFile);
+
+      sessWS1.exportWorkspaceSystemView(fout, false, false);
+      fout.close();
+
+      fin = new FileInputStream(tempFile);
+
+      Map<String, Object> context = new HashMap<String, Object>();
+      context.put(ContentImporter.RESPECT_PROPERTY_DEFINITIONS_CONSTRAINTS, true);
+
+      SessionImpl sessWS2 = (SessionImpl) repository.login(credentials, "ws2");
+      NodeData rootData = ((NodeData) ((NodeImpl) sessWS2.getRootNode()).getData());
+      TransactionableDataManager dataManager = sessWS2.getTransientNodesManager()
+                                                      .getTransactManager();
+      ExportImportFactory eiFactory = new ExportImportFactory();
+
+      StreamImporter importer = eiFactory.getWorkspaceImporter(rootData,
+                                                               ImportUUIDBehavior.IMPORT_UUID_COLLISION_THROW,
+                                                               dataManager,
+                                                               dataManager,
+                                                               (NodeTypeManagerImpl) repository.getNodeTypeManager(),
+                                                               sessWS2.getLocationFactory(),
+                                                               sessWS2.getValueFactory(),
+                                                               repository.getNamespaceRegistry(),
+                                                               sessWS2.getAccessManager(),
+                                                               sessWS2.getUserState(),
+                                                               context,
+                                                               repository,
+                                                               sessWS2.getWorkspace().getName());
+      importer.importStream(fin);
+      sessWS2.save();
+      sessWS2.logout();
+
+    } finally {
+      if (fout != null) {
+        fout.close();
+      }
+      if (fin != null) {
+        fin.close();
+      }
+      tempFile.delete();
+    }
+  }
+
+}
Index: component/ext/src/test/java/conf/standalone/test-configuration.xml
===================================================================
--- component/ext/src/test/java/conf/standalone/test-configuration.xml	(revision 63937)
+++ component/ext/src/test/java/conf/standalone/test-configuration.xml	(working copy)
@@ -1,441 +1,441 @@
-<configuration>
-  <component>
-    <key>org.exoplatform.services.log.LogConfigurationInitializer</key>
-    <type>org.exoplatform.services.log.LogConfigurationInitializer</type>
-    <init-params>
-      <value-param>
-        <name>logger</name>
-        <value>org.exoplatform.services.log.impl.BufferedLog4JLogger</value>
-      </value-param>
-      <value-param>
-        <name>configurator</name>
-        <value>org.exoplatform.services.log.impl.Log4JConfigurator</value>
-      </value-param>
-      <properties-param>
-        <name>properties</name>
-        <description>Log4J properties</description>
-        <property name="log4j.rootLogger" value="INFO, stdout, file" />
-
-        <property name="log4j.appender.stdout" value="org.apache.log4j.ConsoleAppender" />
-        <property name="log4j.appender.stdout.threshold" value="INFO" />
-
-        <property name="log4j.appender.stdout.layout" value="org.apache.log4j.PatternLayout" />
-        <property name="log4j.appender.stdout.layout.ConversionPattern" value="%d{dd.MM.yyyy HH:mm:ss} *%-5p* [%t] %c{1}: %m (%F, line %L) %n" />
-
-        <property name="log4j.appender.file" value="org.apache.log4j.FileAppender" />
-        <property name="log4j.appender.file.File" value="target/jcr.log" />
-
-        <property name="log4j.appender.file.layout" value="org.apache.log4j.PatternLayout" />
-        <property name="log4j.appender.file.layout.ConversionPattern" value="%d{dd.MM.yyyy HH:mm:ss} *%-5p* [%t] %c{1}: %m (%F, line %L) %n" />
-
-        <!-- property name="log4j.category.ext.BackupScheduler" value="DEBUG"/>
-        <property name="log4j.category.ext.BackupManagerImpl" value="DEBUG"/ -->
-
-      </properties-param>
-    </init-params>
-  </component>
-
-  <!--  backup -->
-  <component>
-    <key>org.exoplatform.services.jcr.ext.backup.BackupManager</key>
-    <type>org.exoplatform.services.jcr.ext.backup.impl.BackupManagerImpl</type>
-    <init-params>
-      <properties-param>
-        <name>backup-properties</name>
-        <property name="default-incremental-job-period" value="3600" /><!-- set default incremental periond = 60 minutes  -->
-        <property name="full-backup-type" value="org.exoplatform.services.jcr.ext.backup.impl.fs.FullBackupJob" />
-        <property name="incremental-backup-type" value="org.exoplatform.services.jcr.ext.backup.impl.fs.IncrementalBackupJob" />
-        <property name="backup-dir" value="target/backup" />
-      </properties-param>
-    </init-params>
-  </component>
-
-  <!-- REST -->
-  <component>
-    <type>org.exoplatform.services.jcr.ext.registry.RESTRegistryService</type>
-  </component>
-
-  <component>
-    <type>org.exoplatform.services.jcr.ext.app.ThreadLocalSessionProviderService</type>
-  </component>
-
-  <component>
-    <type>org.exoplatform.services.rest.ResourceDispatcher</type>
-  </component>
-
-  <component>
-    <type>org.exoplatform.services.rest.ResourceBinder</type>
-    <init-params>
-      <value-param>
-        <name>strategy</name>
-        <value>org.exoplatform.services.rest.container.HTTPAnnotatedContainerResolvingStrategy</value>
-      </value-param>
-    </init-params>
-  </component>
-
-  <component>
-    <type>org.exoplatform.services.jcr.ext.registry.RegistryService</type>
-    <init-params>
-      <properties-param>
-        <name>locations</name>
-        <property name="db1" value="ws2" />
-      </properties-param>
-    </init-params>
-  </component>
-
-  <component>
-    <type>org.exoplatform.services.jcr.impl.ext.action.SessionActionCatalog</type>
-
-    <component-plugins>
-      <component-plugin>
-        <name>addActions</name>
-        <set-method>addPlugin</set-method>
-        <type>org.exoplatform.services.jcr.impl.ext.action.AddActionsPlugin</type>
-        <description>add actions plugin</description>
-        <init-params>
-          <object-param>
-            <name>actions</name>
-            <object type="org.exoplatform.services.jcr.impl.ext.action.AddActionsPlugin$ActionsConfig">
-              <field name="actions">
-                <collection type="java.util.ArrayList">
-                  <!--
-                    an example <value> <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration"> <field
-                    name="eventTypes"><string>addNode</string></field> <field name="path"><string>/test</string></field> <field
-                    name="isDeep"><boolean>true</boolean></field> <field name="nodeTypes"><string>nt:unstructured</string></field> <field
-                    name="workspace"><string>production</string></field> <field
-                    name="actionClassName"><string>org.exoplatform.services.jcr.ext.DummyAction</string></field> </object> </value>
-                  -->
-                  <value>
-                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
-                      <field name="eventTypes">
-                        <string>addProperty,changeProperty</string>
-                      </field>
-                      <field name="path">
-                        <string>/MetaDataActionTest/testAddContent</string>
-                      </field>
-                      <field name="isDeep">
-                        <boolean>true</boolean>
-                      </field>
-                      <field name="nodeTypes">
-                        <string>nt:resource</string>
-                      </field>
-                      <field name="actionClassName">
-                        <string>org.exoplatform.services.jcr.ext.metadata.AddMetadataAction</string>
-                      </field>
-                    </object>
-                  </value>
-                  <value>
-                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
-                      <field name="eventTypes">
-                        <string>addNode</string>
-                      </field>
-                      <field name="path">
-                        <string>/MetaDataActionTest/testSetMetaData</string>
-                      </field>
-                      <field name="isDeep">
-                        <boolean>false</boolean>
-                      </field>
-                      <field name="actionClassName">
-                        <string>org.exoplatform.services.jcr.ext.metadata.SetDCMetadataAction</string>
-                      </field>
-                    </object>
-                  </value>
-
-                  <value>
-                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
-                      <field name="eventTypes">
-                        <string>addNode</string>
-                      </field>
-                      <field name="path">
-                        <string>/test</string>
-                      </field>
-                      <field name="isDeep">
-                        <boolean>true</boolean>
-                      </field>
-                      <field name="actionClassName">
-                        <string>org.exoplatform.services.jcr.ext.owner.AddOwneableAction</string>
-                      </field>
-                    </object>
-                  </value>
-
-                  <!-- AddAuditableAction -->
-
-                  <value>
-                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
-                      <field name="eventTypes">
-                        <string>addNode</string>
-                      </field>
-                      <field name="path">
-                        <string>/AuditServiceTest/deep</string>
-                      </field>
-                      <field name="isDeep">
-                        <boolean>true</boolean>
-                      </field>
-                      <field name="actionClassName">
-                        <string>org.exoplatform.services.jcr.ext.audit.AddAuditableAction</string>
-                      </field>
-                    </object>
-                  </value>
-
-                  <value>
-                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
-                      <field name="eventTypes">
-                        <string>addNode</string>
-                      </field>
-                      <field name="path">
-                        <string>/AuditServiceTest/notdeep</string>
-                      </field>
-                      <field name="isDeep">
-                        <boolean>false</boolean>
-                      </field>
-                      <field name="actionClassName">
-                        <string>org.exoplatform.services.jcr.ext.audit.AddAuditableAction</string>
-                      </field>
-                    </object>
-                  </value>
-
-                  <!-- AddAuditableAction -->
-                  <!-- AuditAction -->
-
-                  <value>
-                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
-                      <field name="eventTypes">
-                        <string>addProperty,changeProperty,removeProperty</string>
-                      </field>
-                      <field name="path">
-                        <string>/AuditServiceTest/deep</string>
-                      </field>
-                      <field name="nodeTypes">
-                        <string>exo:auditable</string>
-                      </field>
-                      <field name="isDeep">
-                        <boolean>true</boolean>
-                      </field>
-                      <field name="actionClassName">
-                        <string>org.exoplatform.services.jcr.ext.audit.AuditAction</string>
-                      </field>
-                    </object>
-                  </value>
-                  <value>
-                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
-                      <field name="eventTypes">
-                        <string>addProperty,changeProperty,removeProperty</string>
-                      </field>
-                      <field name="path">
-                        <string>/AuditServiceTest/notdeep</string>
-                      </field>
-                      <field name="nodeTypes">
-                        <string>exo:auditable</string>
-                      </field>
-                      <field name="isDeep">
-                        <boolean>true</boolean>
-                      </field>
-                      <field name="actionClassName">
-                        <string>org.exoplatform.services.jcr.ext.audit.AuditAction</string>
-                      </field>
-                    </object>
-                  </value>
-                  <value>
-                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
-                      <field name="eventTypes">
-                        <string>addProperty,changeProperty,removeProperty</string>
-                      </field>
-                      <field name="path">
-                        <string>/AuditServiceTest/mixin</string>
-                      </field>
-                      <field name="nodeTypes">
-                        <string>exo:auditable</string>
-                      </field>
-                      <field name="isDeep">
-                        <boolean>false</boolean>
-                      </field>
-                      <field name="actionClassName">
-                        <string>org.exoplatform.services.jcr.ext.audit.AuditAction</string>
-                      </field>
-                    </object>
-                  </value>
-                  <value>
-                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
-                      <field name="eventTypes">
-                        <string>addMixin</string>
-                      </field>
-                      <field name="path">
-                        <string>/AuditServiceTest/mixin</string>
-                      </field>
-                      <field name="nodeTypes">
-                        <string>exo:auditable</string>
-                      </field>
-                      <field name="isDeep">
-                        <boolean>true</boolean>
-                      </field>
-                      <field name="actionClassName">
-                        <string>org.exoplatform.services.jcr.ext.audit.AuditAction</string>
-                      </field>
-                    </object>
-                  </value>
-
-                  <!-- AuditAction -->
-                  <!-- RemoveAuditableAction -->
-                  <value>
-                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
-                      <field name="eventTypes">
-                        <string>removeNode</string>
-                      </field>
-                      <field name="path">
-                        <string>/AuditServiceTest</string>
-                      </field>
-                      <!-- field  name="nodeTypes"><string>exo:auditable</string></field -->
-                      <field name="isDeep">
-                        <boolean>true</boolean>
-                      </field>
-                      <field name="actionClassName">
-                        <string>org.exoplatform.services.jcr.ext.audit.RemoveAuditableAction</string>
-                      </field>
-                    </object>
-                  </value>
-                </collection>
-                <!-- RemoveAuditableAction -->
-              </field>
-            </object>
-          </object-param>
-        </init-params>
-      </component-plugin>
-
-    </component-plugins>
-
-  </component>
-
-  <component>
-    <key>org.exoplatform.services.jcr.ext.audit.AuditService</key>
-    <type>org.exoplatform.services.jcr.ext.audit.AuditServiceImpl</type>
-    <init-params>
-      <value-param>
-        <name>adminIdentity</name>
-        <value>root;john</value>
-      </value-param>
-    </init-params>
-  </component>
-
-  <component>
-    <key>org.exoplatform.services.jcr.RepositoryService</key>
-    <type>org.exoplatform.services.jcr.impl.RepositoryServiceImpl</type>
-    <component-plugins>
-      <component-plugin>
-        <name>add.namespaces</name>
-        <set-method>addPlugin</set-method>
-        <type>org.exoplatform.services.jcr.impl.AddNamespacesPlugin</type>
-        <init-params>
-          <properties-param>
-            <name>namespaces</name>
-            <property name="dc" value="http://purl.org/dc/elements/1.1/" />
-          </properties-param>
-        </init-params>
-      </component-plugin>
-      <component-plugin>
-        <name>add.nodeType</name>
-        <set-method>addPlugin</set-method>
-        <type>org.exoplatform.services.jcr.impl.AddNodeTypePlugin</type>
-        <init-params>
-          <values-param>
-            <name>autoCreatedInNewRepository</name>
-            <description>Node types configuration file</description>
-            <value>jar:/conf/ext-nodetypes-config.xml</value>
-            <value>jar:/conf/organization-nodetypes.xml</value>
-          </values-param>
-        </init-params>
-      </component-plugin>
-    </component-plugins>
-  </component>
-
-  <component>
-    <key>org.exoplatform.services.jcr.config.RepositoryServiceConfiguration</key>
-    <type>org.exoplatform.services.jcr.impl.config.RepositoryServiceConfigurationImpl</type>
-    <init-params>
-      <value-param>
-        <name>conf-path</name>
-        <description>JCR configuration file</description>
-        <value>jar:/conf/standalone/test-jcr-ext-config.xml</value>
-      </value-param>
-    </init-params>
-  </component>
-
-  <!--component>
-    <type>org.exoplatform.services.organization.impl.mock.DummyOrganizationService</type>
-  </component-->
-
-  <component>
-    <key>org.exoplatform.services.security.Authenticator</key>
-    <type>org.exoplatform.services.organization.auth.OrganizationAuthenticatorImpl</type>
-  </component>
-
-  <component>
-    <type>org.exoplatform.services.jcr.ext.resource.NodeRepresentationService</type>
-  </component>
-
-  <component>
-    <type>org.exoplatform.services.jcr.ext.resource.representation.NtFileNodeRepresentationFactory</type>
-  </component>
-
-  <component>
-    <type>org.exoplatform.services.jcr.ext.resource.representation.NtResourceNodeRepresentationFactory</type>
-  </component>
-
-  <component>
-    <type>org.exoplatform.services.jcr.ext.resource.jcr.Handler</type>
-  </component>
-
-  <component>
-    <type>org.exoplatform.services.jcr.ext.script.groovy.GroovyScript2RestLoader</type>
-    <init-params>
-      <object-param>
-        <name>observation.config</name>
-        <object type="org.exoplatform.services.jcr.ext.script.groovy.GroovyScript2RestLoader$ObservationListenerConfiguration">
-          <field name="repository">
-            <string>db1</string>
-          </field>
-          <field name="workspaces">
-            <collection type="java.util.ArrayList">
-              <value>
-                <string>ws</string>
-              </value>
-            </collection>
-          </field>
-        </object>
-      </object-param>
-    </init-params>
-  </component>
-
-  <component>
-    <key>org.exoplatform.services.organization.OrganizationService</key>
-    <type>org.exoplatform.services.jcr.ext.organization.JCROrganizationServiceImpl</type>
-    <init-params>
-      <value-param>
-        <name>storage-workspace</name>
-        <description>Workspace in default repository where organization storage will be created</description>
-        <value>ws</value>
-      </value-param>
-    </init-params>
-  </component>
-
-  <!--
-    component> <key>org.exoplatform.services.database.HibernateService</key> <jmx-name>database:type=HibernateService</jmx-name>
-    <type>org.exoplatform.services.database.impl.HibernateServiceImpl</type> <init-params> <properties-param> <name>hibernate.properties</name>
-    <description>Default Hibernate Service</description> <property name="hibernate.show_sql" value="false"/> <property
-    name="hibernate.cglib.use_reflection_optimizer" value="true"/> <property name="hibernate.connection.url" value="jdbc:hsqldb:file:../temp/data/exodb"/>
-    <property name="hibernate.connection.driver_class" value="org.hsqldb.jdbcDriver"/> <property name="hibernate.connection.autocommit" value="true"/> <property
-    name="hibernate.connection.username" value="sa"/> <property name="hibernate.connection.password" value=""/> <property name="hibernate.dialect"
-    value="org.hibernate.dialect.HSQLDialect"/> <property name="hibernate.c3p0.min_size" value="5"/> <property name="hibernate.c3p0.max_size" value="20"/>
-    <property name="hibernate.c3p0.timeout" value="1800"/> <property name="hibernate.c3p0.max_statements" value="50"/> </properties-param> </init-params>
-    </component> <component> <key>org.exoplatform.services.organization.OrganizationService</key>
-    <type>org.exoplatform.services.organization.hibernate.OrganizationServiceImpl</type> </component> <external-component-plugins>
-    <target-component>org.exoplatform.services.database.HibernateService</target-component> <component-plugin> <name>add.hibernate.mapping</name>
-    <set-method>addPlugin</set-method> <type>org.exoplatform.services.database.impl.AddHibernateMappingPlugin</type> <init-params> <values-param>
-    <name>hibernate.mapping</name> <value>org/exoplatform/services/organization/impl/UserImpl.hbm.xml</value>
-    <value>org/exoplatform/services/organization/impl/MembershipImpl.hbm.xml</value> <value>org/exoplatform/services/organization/impl/GroupImpl.hbm.xml</value>
-    <value>org/exoplatform/services/organization/impl/MembershipTypeImpl.hbm.xml</value>
-    <value>org/exoplatform/services/organization/impl/UserProfileData.hbm.xml</value> </values-param> </init-params> </component-plugin>
-    </external-component-plugins
-  -->
+<configuration>
+  <component>
+    <key>org.exoplatform.services.log.LogConfigurationInitializer</key>
+    <type>org.exoplatform.services.log.LogConfigurationInitializer</type>
+    <init-params>
+      <value-param>
+        <name>logger</name>
+        <value>org.exoplatform.services.log.impl.BufferedLog4JLogger</value>
+      </value-param>
+      <value-param>
+        <name>configurator</name>
+        <value>org.exoplatform.services.log.impl.Log4JConfigurator</value>
+      </value-param>
+      <properties-param>
+        <name>properties</name>
+        <description>Log4J properties</description>
+        <property name="log4j.rootLogger" value="INFO, stdout, file" />
+
+        <property name="log4j.appender.stdout" value="org.apache.log4j.ConsoleAppender" />
+        <property name="log4j.appender.stdout.threshold" value="INFO" />
+
+        <property name="log4j.appender.stdout.layout" value="org.apache.log4j.PatternLayout" />
+        <property name="log4j.appender.stdout.layout.ConversionPattern" value="%d{dd.MM.yyyy HH:mm:ss} *%-5p* [%t] %c{1}: %m (%F, line %L) %n" />
+
+        <property name="log4j.appender.file" value="org.apache.log4j.FileAppender" />
+        <property name="log4j.appender.file.File" value="target/jcr.log" />
+
+        <property name="log4j.appender.file.layout" value="org.apache.log4j.PatternLayout" />
+        <property name="log4j.appender.file.layout.ConversionPattern" value="%d{dd.MM.yyyy HH:mm:ss} *%-5p* [%t] %c{1}: %m (%F, line %L) %n" />
+
+        <!-- property name="log4j.category.ext.BackupScheduler" value="DEBUG"/>
+        <property name="log4j.category.ext.BackupManagerImpl" value="DEBUG"/ -->
+
+      </properties-param>
+    </init-params>
+  </component>
+
+  <!--  backup -->
+  <component>
+    <key>org.exoplatform.services.jcr.ext.backup.BackupManager</key>
+    <type>org.exoplatform.services.jcr.ext.backup.impl.BackupManagerImpl</type>
+    <init-params>
+      <properties-param>
+        <name>backup-properties</name>
+        <property name="default-incremental-job-period" value="3600" /><!-- set default incremental periond = 60 minutes  -->
+        <property name="full-backup-type" value="org.exoplatform.services.jcr.ext.backup.impl.fs.FullBackupJob" />
+        <property name="incremental-backup-type" value="org.exoplatform.services.jcr.ext.backup.impl.fs.IncrementalBackupJob" />
+        <property name="backup-dir" value="target/backup" />
+      </properties-param>
+    </init-params>
+  </component>
+
+  <!-- REST -->
+  <component>
+    <type>org.exoplatform.services.jcr.ext.registry.RESTRegistryService</type>
+  </component>
+
+  <component>
+    <type>org.exoplatform.services.jcr.ext.app.ThreadLocalSessionProviderService</type>
+  </component>
+
+  <component>
+    <type>org.exoplatform.services.rest.ResourceDispatcher</type>
+  </component>
+
+  <component>
+    <type>org.exoplatform.services.rest.ResourceBinder</type>
+    <init-params>
+      <value-param>
+        <name>strategy</name>
+        <value>org.exoplatform.services.rest.container.HTTPAnnotatedContainerResolvingStrategy</value>
+      </value-param>
+    </init-params>
+  </component>
+
+  <component>
+    <type>org.exoplatform.services.jcr.ext.registry.RegistryService</type>
+    <init-params>
+      <properties-param>
+        <name>locations</name>
+        <property name="db1" value="ws2" />
+      </properties-param>
+    </init-params>
+  </component>
+
+  <component>
+    <type>org.exoplatform.services.jcr.impl.ext.action.SessionActionCatalog</type>
+
+    <component-plugins>
+      <component-plugin>
+        <name>addActions</name>
+        <set-method>addPlugin</set-method>
+        <type>org.exoplatform.services.jcr.impl.ext.action.AddActionsPlugin</type>
+        <description>add actions plugin</description>
+        <init-params>
+          <object-param>
+            <name>actions</name>
+            <object type="org.exoplatform.services.jcr.impl.ext.action.AddActionsPlugin$ActionsConfig">
+              <field name="actions">
+                <collection type="java.util.ArrayList">
+                  <!--
+                    an example <value> <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration"> <field
+                    name="eventTypes"><string>addNode</string></field> <field name="path"><string>/test</string></field> <field
+                    name="isDeep"><boolean>true</boolean></field> <field name="nodeTypes"><string>nt:unstructured</string></field> <field
+                    name="workspace"><string>production</string></field> <field
+                    name="actionClassName"><string>org.exoplatform.services.jcr.ext.DummyAction</string></field> </object> </value>
+                  -->
+                  <value>
+                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
+                      <field name="eventTypes">
+                        <string>addProperty,changeProperty</string>
+                      </field>
+                      <field name="path">
+                        <string>/MetaDataActionTest/testAddContent</string>
+                      </field>
+                      <field name="isDeep">
+                        <boolean>true</boolean>
+                      </field>
+                      <field name="nodeTypes">
+                        <string>nt:resource</string>
+                      </field>
+                      <field name="actionClassName">
+                        <string>org.exoplatform.services.jcr.ext.metadata.AddMetadataAction</string>
+                      </field>
+                    </object>
+                  </value>
+                  <value>
+                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
+                      <field name="eventTypes">
+                        <string>addNode</string>
+                      </field>
+                      <field name="path">
+                        <string>/MetaDataActionTest/testSetMetaData</string>
+                      </field>
+                      <field name="isDeep">
+                        <boolean>false</boolean>
+                      </field>
+                      <field name="actionClassName">
+                        <string>org.exoplatform.services.jcr.ext.metadata.SetDCMetadataAction</string>
+                      </field>
+                    </object>
+                  </value>
+
+                  <value>
+                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
+                      <field name="eventTypes">
+                        <string>addNode</string>
+                      </field>
+                      <field name="path">
+                        <string>/test</string>
+                      </field>
+                      <field name="isDeep">
+                        <boolean>true</boolean>
+                      </field>
+                      <field name="actionClassName">
+                        <string>org.exoplatform.services.jcr.ext.owner.AddOwneableAction</string>
+                      </field>
+                    </object>
+                  </value>
+
+                  <!-- AddAuditableAction -->
+
+                  <value>
+                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
+                      <field name="eventTypes">
+                        <string>addNode</string>
+                      </field>
+                      <field name="path">
+                        <string>/AuditServiceTest/deep</string>
+                      </field>
+                      <field name="isDeep">
+                        <boolean>true</boolean>
+                      </field>
+                      <field name="actionClassName">
+                        <string>org.exoplatform.services.jcr.ext.audit.AddAuditableAction</string>
+                      </field>
+                    </object>
+                  </value>
+
+                  <value>
+                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
+                      <field name="eventTypes">
+                        <string>addNode</string>
+                      </field>
+                      <field name="path">
+                        <string>/AuditServiceTest/notdeep</string>
+                      </field>
+                      <field name="isDeep">
+                        <boolean>false</boolean>
+                      </field>
+                      <field name="actionClassName">
+                        <string>org.exoplatform.services.jcr.ext.audit.AddAuditableAction</string>
+                      </field>
+                    </object>
+                  </value>
+
+                  <!-- AddAuditableAction -->
+                  <!-- AuditAction -->
+
+                  <value>
+                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
+                      <field name="eventTypes">
+                        <string>addProperty,changeProperty,removeProperty</string>
+                      </field>
+                      <field name="path">
+                        <string>/AuditServiceTest/deep</string>
+                      </field>
+                      <field name="nodeTypes">
+                        <string>exo:auditable</string>
+                      </field>
+                      <field name="isDeep">
+                        <boolean>true</boolean>
+                      </field>
+                      <field name="actionClassName">
+                        <string>org.exoplatform.services.jcr.ext.audit.AuditAction</string>
+                      </field>
+                    </object>
+                  </value>
+                  <value>
+                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
+                      <field name="eventTypes">
+                        <string>addProperty,changeProperty,removeProperty</string>
+                      </field>
+                      <field name="path">
+                        <string>/AuditServiceTest/notdeep</string>
+                      </field>
+                      <field name="nodeTypes">
+                        <string>exo:auditable</string>
+                      </field>
+                      <field name="isDeep">
+                        <boolean>true</boolean>
+                      </field>
+                      <field name="actionClassName">
+                        <string>org.exoplatform.services.jcr.ext.audit.AuditAction</string>
+                      </field>
+                    </object>
+                  </value>
+                  <value>
+                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
+                      <field name="eventTypes">
+                        <string>addProperty,changeProperty,removeProperty</string>
+                      </field>
+                      <field name="path">
+                        <string>/AuditServiceTest/mixin</string>
+                      </field>
+                      <field name="nodeTypes">
+                        <string>exo:auditable</string>
+                      </field>
+                      <field name="isDeep">
+                        <boolean>false</boolean>
+                      </field>
+                      <field name="actionClassName">
+                        <string>org.exoplatform.services.jcr.ext.audit.AuditAction</string>
+                      </field>
+                    </object>
+                  </value>
+                  <value>
+                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
+                      <field name="eventTypes">
+                        <string>addMixin</string>
+                      </field>
+                      <field name="path">
+                        <string>/AuditServiceTest/mixin</string>
+                      </field>
+                      <field name="nodeTypes">
+                        <string>exo:auditable</string>
+                      </field>
+                      <field name="isDeep">
+                        <boolean>true</boolean>
+                      </field>
+                      <field name="actionClassName">
+                        <string>org.exoplatform.services.jcr.ext.audit.AuditAction</string>
+                      </field>
+                    </object>
+                  </value>
+
+                  <!-- AuditAction -->
+                  <!-- RemoveAuditableAction -->
+                  <value>
+                    <object type="org.exoplatform.services.jcr.impl.ext.action.ActionConfiguration">
+                      <field name="eventTypes">
+                        <string>removeNode</string>
+                      </field>
+                      <field name="path">
+                        <string>/AuditServiceTest</string>
+                      </field>
+                      <!-- field  name="nodeTypes"><string>exo:auditable</string></field -->
+                      <field name="isDeep">
+                        <boolean>true</boolean>
+                      </field>
+                      <field name="actionClassName">
+                        <string>org.exoplatform.services.jcr.ext.audit.RemoveAuditableAction</string>
+                      </field>
+                    </object>
+                  </value>
+                </collection>
+                <!-- RemoveAuditableAction -->
+              </field>
+            </object>
+          </object-param>
+        </init-params>
+      </component-plugin>
+
+    </component-plugins>
+
+  </component>
+
+  <component>
+    <key>org.exoplatform.services.jcr.ext.audit.AuditService</key>
+    <type>org.exoplatform.services.jcr.ext.audit.AuditServiceImpl</type>
+    <init-params>
+      <value-param>
+        <name>adminIdentity</name>
+        <value>root;john</value>
+      </value-param>
+    </init-params>
+  </component>
+
+  <component>
+    <key>org.exoplatform.services.jcr.RepositoryService</key>
+    <type>org.exoplatform.services.jcr.impl.RepositoryServiceImpl</type>
+    <component-plugins>
+      <component-plugin>
+        <name>add.namespaces</name>
+        <set-method>addPlugin</set-method>
+        <type>org.exoplatform.services.jcr.impl.AddNamespacesPlugin</type>
+        <init-params>
+          <properties-param>
+            <name>namespaces</name>
+            <property name="dc" value="http://purl.org/dc/elements/1.1/" />
+          </properties-param>
+        </init-params>
+      </component-plugin>
+      <component-plugin>
+        <name>add.nodeType</name>
+        <set-method>addPlugin</set-method>
+        <type>org.exoplatform.services.jcr.impl.AddNodeTypePlugin</type>
+        <init-params>
+          <values-param>
+            <name>autoCreatedInNewRepository</name>
+            <description>Node types configuration file</description>
+            <value>jar:/conf/ext-nodetypes-config.xml</value>
+            <value>jar:/conf/organization-nodetypes.xml</value>
+          </values-param>
+        </init-params>
+      </component-plugin>
+    </component-plugins>
+  </component>
+
+  <component>
+    <key>org.exoplatform.services.jcr.config.RepositoryServiceConfiguration</key>
+    <type>org.exoplatform.services.jcr.impl.config.RepositoryServiceConfigurationImpl</type>
+    <init-params>
+      <value-param>
+        <name>conf-path</name>
+        <description>JCR configuration file</description>
+        <value>jar:/conf/standalone/test-jcr-ext-config.xml</value>
+      </value-param>
+    </init-params>
+  </component>
+
+  <!--component>
+    <type>org.exoplatform.services.organization.impl.mock.DummyOrganizationService</type>
+  </component-->
+
+  <component>
+    <key>org.exoplatform.services.security.Authenticator</key>
+    <type>org.exoplatform.services.organization.auth.OrganizationAuthenticatorImpl</type>
+  </component>
+
+  <component>
+    <type>org.exoplatform.services.jcr.ext.resource.NodeRepresentationService</type>
+  </component>
+
+  <component>
+    <type>org.exoplatform.services.jcr.ext.resource.representation.NtFileNodeRepresentationFactory</type>
+  </component>
+
+  <component>
+    <type>org.exoplatform.services.jcr.ext.resource.representation.NtResourceNodeRepresentationFactory</type>
+  </component>
+
+  <component>
+    <type>org.exoplatform.services.jcr.ext.resource.jcr.Handler</type>
+  </component>
+
+  <component>
+    <type>org.exoplatform.services.jcr.ext.script.groovy.GroovyScript2RestLoader</type>
+    <init-params>
+      <object-param>
+        <name>observation.config</name>
+        <object type="org.exoplatform.services.jcr.ext.script.groovy.GroovyScript2RestLoader$ObservationListenerConfiguration">
+          <field name="repository">
+            <string>db1</string>
+          </field>
+          <field name="workspaces">
+            <collection type="java.util.ArrayList">
+              <value>
+                <string>ws</string>
+              </value>
+            </collection>
+          </field>
+        </object>
+      </object-param>
+    </init-params>
+  </component>
+
+  <component>
+    <key>org.exoplatform.services.organization.OrganizationService</key>
+    <type>org.exoplatform.services.jcr.ext.organization.JCROrganizationServiceImpl</type>
+    <init-params>
+      <value-param>
+        <name>storage-workspace</name>
+        <description>Workspace in default repository where organization storage will be created</description>
+        <value>ws</value>
+      </value-param>
+    </init-params>
+  </component>
+
+  <!--
+    component> <key>org.exoplatform.services.database.HibernateService</key> <jmx-name>database:type=HibernateService</jmx-name>
+    <type>org.exoplatform.services.database.impl.HibernateServiceImpl</type> <init-params> <properties-param> <name>hibernate.properties</name>
+    <description>Default Hibernate Service</description> <property name="hibernate.show_sql" value="false"/> <property
+    name="hibernate.cglib.use_reflection_optimizer" value="true"/> <property name="hibernate.connection.url" value="jdbc:hsqldb:file:../temp/data/exodb"/>
+    <property name="hibernate.connection.driver_class" value="org.hsqldb.jdbcDriver"/> <property name="hibernate.connection.autocommit" value="true"/> <property
+    name="hibernate.connection.username" value="sa"/> <property name="hibernate.connection.password" value=""/> <property name="hibernate.dialect"
+    value="org.hibernate.dialect.HSQLDialect"/> <property name="hibernate.c3p0.min_size" value="5"/> <property name="hibernate.c3p0.max_size" value="20"/>
+    <property name="hibernate.c3p0.timeout" value="1800"/> <property name="hibernate.c3p0.max_statements" value="50"/> </properties-param> </init-params>
+    </component> <component> <key>org.exoplatform.services.organization.OrganizationService</key>
+    <type>org.exoplatform.services.organization.hibernate.OrganizationServiceImpl</type> </component> <external-component-plugins>
+    <target-component>org.exoplatform.services.database.HibernateService</target-component> <component-plugin> <name>add.hibernate.mapping</name>
+    <set-method>addPlugin</set-method> <type>org.exoplatform.services.database.impl.AddHibernateMappingPlugin</type> <init-params> <values-param>
+    <name>hibernate.mapping</name> <value>org/exoplatform/services/organization/impl/UserImpl.hbm.xml</value>
+    <value>org/exoplatform/services/organization/impl/MembershipImpl.hbm.xml</value> <value>org/exoplatform/services/organization/impl/GroupImpl.hbm.xml</value>
+    <value>org/exoplatform/services/organization/impl/MembershipTypeImpl.hbm.xml</value>
+    <value>org/exoplatform/services/organization/impl/UserProfileData.hbm.xml</value> </values-param> </init-params> </component-plugin>
+    </external-component-plugins
+  -->
   <external-component-plugins>
     <target-component>org.exoplatform.services.organization.OrganizationService</target-component>
     <component-plugin>
@@ -678,600 +678,628 @@
       </init-params>
     </component-plugin>
   </external-component-plugins>
-
-  <external-component-plugins>
-    <target-component>org.exoplatform.services.naming.InitialContextInitializer</target-component>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/portal" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr1</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr2</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr2" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr3</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr3" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr4</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr4" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr5</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr5" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr6</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr6" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr7</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr7" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr8</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr8" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr9</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr9" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr10</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr10" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr11</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr11" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr12</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr12" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr13</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr13" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr14</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr14" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr15</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr15" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr16</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr16" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr17</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr17" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.datasource</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>jdbcjcr18</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.sql.DataSource</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
-          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr18" />
-          <property name="username" value="sa" />
-          <property name="password" value="" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <!-- Resource configuration for UserTransaction
-    use JOTM
-    -->
-    <component-plugin>
-      <name>jotm.tx</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>UserTransaction</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.transaction.UserTransaction</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.objectweb.jotm.UserTransactionFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="jotm.timeout" value="60" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>bind.jcr</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>repo</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.jcr.Repository</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.exoplatform.services.jcr.impl.jndi.BindableRepositoryFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="repositoryName" value="db1" />
-          <!-- property name="containerConfig" value="exo-configuration.xml"/ -->
-        </properties-param>
-      </init-params>
-    </component-plugin>
-    <component-plugin>
-      <name>rmi.jcr</name>
-      <set-method>addPlugin</set-method>
-      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
-      <init-params>
-        <value-param>
-          <name>bind-name</name>
-          <value>rmirepository</value>
-        </value-param>
-        <value-param>
-          <name>class-name</name>
-          <value>javax.jcr.Repository</value>
-        </value-param>
-        <value-param>
-          <name>factory</name>
-          <value>org.exoplatform.services.jcr.rmi.RepositoryFactory</value>
-        </value-param>
-        <properties-param>
-          <name>ref-addresses</name>
-          <description>ref-addresses</description>
-          <property name="url" value="//localhost:9999/repository" />
-        </properties-param>
-      </init-params>
-    </component-plugin>
-  </external-component-plugins>
-
-  <remove-configuration>org.exoplatform.services.scheduler.JobSchedulerService</remove-configuration>
-  <!--<import>jar:/conf/database-configuration.hsql.xml</import> -->
-</configuration>
+
+  <external-component-plugins>
+    <target-component>org.exoplatform.services.naming.InitialContextInitializer</target-component>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/portal" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr1</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr2</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr2" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr3</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr3" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr4</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr4" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr5</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr5" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr6</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr6" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr7</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr7" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr8</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr8" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr9</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr9" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr10</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr10" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr11</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr11" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr12</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr12" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr13</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr13" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr14</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr14" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr15</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr15" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr16</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr16" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr17</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr17" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr18</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr18" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+     <component-plugin>
+      <name>bind.datasource</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>jdbcjcr19</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.sql.DataSource</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.apache.commons.dbcp.BasicDataSourceFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="driverClassName" value="org.hsqldb.jdbcDriver" />
+          <property name="url" value="jdbc:hsqldb:file:target/temp/data/jcr19" />
+          <property name="username" value="sa" />
+          <property name="password" value="" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+
+    <!-- Resource configuration for UserTransaction
+    use JOTM
+    -->
+    <component-plugin>
+      <name>jotm.tx</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>UserTransaction</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.transaction.UserTransaction</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.objectweb.jotm.UserTransactionFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="jotm.timeout" value="60" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>bind.jcr</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>repo</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.jcr.Repository</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.exoplatform.services.jcr.impl.jndi.BindableRepositoryFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="repositoryName" value="db1" />
+          <!-- property name="containerConfig" value="exo-configuration.xml"/ -->
+        </properties-param>
+      </init-params>
+    </component-plugin>
+    <component-plugin>
+      <name>rmi.jcr</name>
+      <set-method>addPlugin</set-method>
+      <type>org.exoplatform.services.naming.BindReferencePlugin</type>
+      <init-params>
+        <value-param>
+          <name>bind-name</name>
+          <value>rmirepository</value>
+        </value-param>
+        <value-param>
+          <name>class-name</name>
+          <value>javax.jcr.Repository</value>
+        </value-param>
+        <value-param>
+          <name>factory</name>
+          <value>org.exoplatform.services.jcr.rmi.RepositoryFactory</value>
+        </value-param>
+        <properties-param>
+          <name>ref-addresses</name>
+          <description>ref-addresses</description>
+          <property name="url" value="//localhost:9999/repository" />
+        </properties-param>
+      </init-params>
+    </component-plugin>
+  </external-component-plugins>
+
+  <remove-configuration>org.exoplatform.services.scheduler.JobSchedulerService</remove-configuration>
+  <!--<import>jar:/conf/database-configuration.hsql.xml</import> -->
+</configuration>
Index: component/ext/src/test/java/org/exoplatform/services/jcr/ext/backup/TestBackupManager.java
===================================================================
--- component/ext/src/test/java/org/exoplatform/services/jcr/ext/backup/TestBackupManager.java	(revision 63937)
+++ component/ext/src/test/java/org/exoplatform/services/jcr/ext/backup/TestBackupManager.java	(working copy)
@@ -99,6 +99,80 @@
       fail("There are no backup files in " + backDir.getAbsolutePath());
   }
 
+  public void testJCR1479FullBackupRestore() throws Exception {
+
+    SessionImpl sessWS1 = (SessionImpl)repository.login(credentials, "ws1");
+
+    Node n = sessWS1.getRootNode().addNode("testRefNode");
+    n.addMixin("mix:referenceable");
+    sessWS1.save();
+
+    try {
+      // backup
+      File backDir = new File("target/backup/ws1jcr1479");
+      backDir.mkdirs();
+
+      BackupConfig config = new BackupConfig();
+      config.setRepository(repository.getName());
+      config.setWorkspace("ws1");
+      config.setBuckupType(BackupManager.FULL_BACKUP_ONLY);
+
+      config.setBackupDir(backDir);
+
+      backup.startBackup(config);
+
+      BackupChain bch = backup.findBackup(repository.getName(), "ws1");
+
+      // wait till full backup will be stopped
+      while (bch.getFullBackupState() != BackupJob.FINISHED) {
+        Thread.yield();
+        Thread.sleep(50);
+      }
+
+      // stop fullBackup
+
+      if (bch != null)
+        backup.stopBackup(bch);
+      else
+        fail("Can't get fullBackup chain");
+
+      // restore
+      RepositoryEntry re = (RepositoryEntry) ws1Session.getContainer()
+                                                       .getComponentInstanceOfType(RepositoryEntry.class);
+      WorkspaceEntry ws1back = makeWorkspaceEntry("ws1backjcr1479", "jdbcjcr19");
+
+      repository.configWorkspace(ws1back);
+
+      // BackupChainLog bchLog = new BackupChainLog(backDir, rconfig);
+      File backLog = new File(bch.getLogFilePath());
+      if (backLog.exists()) {
+        BackupChainLog bchLog = new BackupChainLog(backLog);
+
+        backup.restore(bchLog, re, ws1back);
+
+        // check
+        SessionImpl back1 = null;
+        try {
+          back1 = (SessionImpl) repository.login(credentials, "ws1back");
+          Node ws1backTestRoot = back1.getRootNode().getNode("backupTest");
+          assertEquals("Restored content should be same",
+                       "property-5",
+                       ws1backTestRoot.getNode("node_5").getProperty("exo:data").getString());
+        } catch (Exception e) {
+          e.printStackTrace();
+          fail(e.getMessage());
+        } finally {
+          if (back1 != null)
+            back1.logout();
+        }
+      } else
+        fail("There are no backup files in " + backDir.getAbsolutePath());
+    } finally {
+      n.remove();
+      sessWS1.save();
+    }
+  }
+
   public void testIncrementalBackupRestore() throws Exception {
     // full backup & incremental
     File backDir = new File("target/backup/ws1.incr");
